name: AI PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-review:
    name: Automated AI Code Review with RAG
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è git diff

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Ollama for embeddings
        run: |
          echo "Installing Ollama..."
          curl -fsSL https://ollama.com/install.sh | sh

          echo "Starting Ollama server..."
          ollama serve > ollama.log 2>&1 &
          sleep 5

          echo "Pulling nomic-embed-text model..."
          ollama pull nomic-embed-text

      - name: Build project
        run: |
          ./gradlew build -x test --no-daemon

      - name: Index documentation for RAG
        run: |
          echo "Creating index directory..."
          mkdir -p ~/.ai_advent/embedding_index

          echo "Note: Indexing is currently done during review execution"
          echo "Future improvement: Pre-index documentation here"

      - name: Run AI PR Review with RAG
        id: review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PR_REVIEW_BASE: origin/${{ github.base_ref }}
          PR_REVIEW_USE_RAG: "true"
          PR_REVIEW_MODEL: "gpt-4o"
          PR_REVIEW_MIN_SCORE: "0.25"
          PR_REVIEW_OUTPUT_FORMAT: "markdown"
        run: |
          echo "Running AI PR Review..."
          mkdir -p build
          OUTPUT_FILE="build/review.md"

          # –ó–∞–ø—É—Å–∫–∞–µ–º PR —Ä–µ–≤—å—é
          ./gradlew :desktopApp:runPrReview \
            -Pbase="origin/${{ github.base_ref }}" \
            -PuseRag=true \
            -Pmodel="gpt-4o" \
            -PminScore=0.25 \
            -PoutputFormat=markdown \
            --no-daemon \
            > "$OUTPUT_FILE" 2>&1 || {
              echo "‚ö†Ô∏è Review encountered an error, creating fallback report..."
              cat > "$OUTPUT_FILE" <<EOF
          # ü§ñ AI Code Review

          ## ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

          –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–≤—å—é —Å—Ç–æ–ª–∫–Ω—É–ª–æ—Å—å —Å –ø—Ä–æ–±–ª–µ–º–æ–π, –Ω–æ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ª–µ–¥—É—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:

          ### üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

          \`\`\`
          $(git diff --stat origin/${{ github.base_ref }}...HEAD)
          \`\`\`

          ### üìÅ –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

          $(git diff --name-only origin/${{ github.base_ref }}...HEAD | sed 's/^/- /')

          ---

          *–î–ª—è –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ Actions*
          EOF
            }

          echo "Review completed. Output saved to $OUTPUT_FILE"

      - name: Post review comment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = 'build/review.md';

            let reviewContent;
            try {
              reviewContent = fs.readFileSync(path, 'utf8');
            } catch (error) {
              reviewContent = `# ü§ñ AI Code Review\n\n## ‚ùå –û—à–∏–±–∫–∞\n\n–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–µ–≤—å—é.\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ Actions.`;
            }

            // –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç –±–æ—Ç–∞
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ü§ñ AI Code Review')
            );

            const commentBody = reviewContent;

            if (botComment) {
              // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
              console.log('Updated existing comment');
            } else {
              // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
              console.log('Created new comment');
            }

      - name: Upload review artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-review-report
          path: |
            build/review.md
            ollama.log
          retention-days: 30
