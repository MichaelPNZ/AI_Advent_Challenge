name: AI PR Review Bot

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Compute diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > diff.txt

      - name: Run AI PR Review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PR_REVIEW_BASE: origin/${{ github.base_ref }}
          PR_REVIEW_MODEL: gpt-5-mini
          PR_REVIEW_MIN_SCORE: "1.0"
          PR_REVIEW_USE_RAG: "true"
          PR_REVIEW_OUTPUT_FORMAT: markdown
        run: |
          chmod +x tools/run-pr-review.sh
          tools/run-pr-review.sh diff.txt build/review.md

      - name: Post review comment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = 'build/review.md';
            let body = '';
            try {
              body = fs.readFileSync(path, 'utf8');
            } catch (e) {
              body = '# ü§ñ AI Code Review\n\n–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–µ–≤—å—é.\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ Actions.';
            }

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ü§ñ AI Code Review')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

      - name: Slack notify (optional)
        if: ${{ always() && env.SLACK_WEBHOOK_URL != '' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -f build/review.md ]; then
            SNIPPET=$(head -n 40 build/review.md | sed 's/"/\\"/g')
          else
            SNIPPET="–û—Ç—á–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏."
          fi
          payload="{\"text\":\"ü§ñ PR Review #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.html_url }}\\n${SNIPPET}\"}"
          curl -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-review-report
          path: |
            build/review.md
            diff.txt
            ollama.log
